<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleeping Baby</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #e8d5f2 0%, #f5e6d3 100%);
            min-height: 100vh;
            padding: 15px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #6b5b7a;
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .baby-container {
            text-align: center;
            padding: 20px 0;
        }
        .baby-svg {
            width: 120px;
            height: 120px;
            transition: transform 0.3s;
        }
        .baby-svg.wiggle {
            animation: wiggle 0.5s ease-in-out infinite;
        }
        .baby-svg.awake {
            animation: cry 0.2s ease-in-out infinite;
        }
        @keyframes wiggle {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        @keyframes cry {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .status-label {
            font-size: 1.4em;
            color: #6b5b7a;
            margin: 15px 0;
            font-weight: 600;
            min-height: 1.5em;
        }
        .timer {
            font-size: 2em;
            color: #9b8aa6;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }
        .pass-btn {
            width: 100%;
            padding: 18px;
            font-size: 1.3em;
            background: linear-gradient(135deg, #a8d5a2 0%, #7bc47f 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s, opacity 0.2s;
        }
        .pass-btn:active { transform: scale(0.98); }
        .pass-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #ccc;
        }
        .players-card {
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .players-title {
            font-size: 0.9em;
            color: #9b8aa6;
            margin-bottom: 10px;
        }
        .player-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .player-row:last-child { border-bottom: none; }
        .player-row.holding {
            background: #f5f0ff;
            margin: 0 -15px;
            padding: 8px 15px;
            border-radius: 10px;
        }
        .player-name {
            font-weight: 600;
            color: #6b5b7a;
            width: 70px;
            font-size: 0.95em;
        }
        .player-bar-container {
            flex: 1;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin-left: 10px;
            overflow: hidden;
        }
        .player-bar {
            height: 100%;
            background: linear-gradient(90deg, #ffb6c1 0%, #ff8fab 100%);
            border-radius: 10px;
            transition: width 0.3s;
            min-width: 0;
        }
        .player-bar.pending {
            background: linear-gradient(90deg, #ffd89b 0%, #f9c846 100%);
            animation: pulse-bar 1s infinite;
        }
        @keyframes pulse-bar {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .setup-card {
            text-align: center;
        }
        .setup-card h2 {
            color: #6b5b7a;
            margin-bottom: 20px;
        }
        .family-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        .family-btn {
            padding: 12px 5px;
            border: 2px solid #e0d5e8;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85em;
            color: #6b5b7a;
            transition: all 0.2s;
        }
        .family-btn:hover { border-color: #a8d5a2; }
        .family-btn.selected {
            border-color: #7bc47f;
            background: #f0fff0;
        }
        .setup-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .setup-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }
        .setup-btn.primary {
            background: linear-gradient(135deg, #a8d5a2 0%, #7bc47f 100%);
            color: white;
        }
        .setup-btn.secondary {
            background: #f0f0f0;
            color: #6b5b7a;
        }
        .join-input {
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #e0d5e8;
            border-radius: 12px;
            width: 100%;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 5px;
            margin-bottom: 10px;
        }
        .room-code {
            font-size: 2em;
            font-weight: bold;
            color: #7bc47f;
            letter-spacing: 8px;
            margin: 10px 0;
        }
        .time-select {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            color: #6b5b7a;
        }
        .time-select select {
            padding: 10px;
            font-size: 1em;
            border: 2px solid #e0d5e8;
            border-radius: 8px;
        }
        .hidden { display: none !important; }
        .waiting-msg {
            color: #9b8aa6;
            font-style: italic;
            margin-top: 15px;
        }
        .game-over {
            text-align: center;
            padding: 30px;
        }
        .game-over h2 {
            color: #6b5b7a;
            margin-bottom: 20px;
        }
        .winner-name {
            font-size: 2em;
            color: #7bc47f;
            margin-bottom: 20px;
        }
        .wake-flash {
            animation: flash-red 0.5s ease-out;
        }
        @keyframes flash-red {
            0% { background: #ffcccc; }
            100% { background: white; }
        }
        .share-code {
            background: #f5f0ff;
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #6b5b7a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ‘¶ Sleeping Baby</h1>

        <!-- Setup Screen -->
        <div id="setupScreen" class="card setup-card">
            <h2>Pick Your Role</h2>
            <div class="family-grid" id="familyGrid"></div>
            
            <div class="time-select">
                <label>Game length:</label>
                <select id="gameLength">
                    <option value="2">2 min</option>
                    <option value="3">3 min</option>
                    <option value="5" selected>5 min</option>
                    <option value="10">10 min</option>
                </select>
            </div>
            
            <div class="setup-actions">
                <button class="setup-btn primary" onclick="createGame()">New Game</button>
                <button class="setup-btn secondary" onclick="showJoin()">Join</button>
            </div>
            
            <div id="joinSection" class="hidden">
                <input type="text" class="join-input" id="joinCode" placeholder="ABC" maxlength="3">
                <button class="setup-btn primary" onclick="joinGame()">Join Game</button>
            </div>
        </div>

        <!-- Waiting Screen -->
        <div id="waitingScreen" class="card hidden">
            <h2 style="color: #6b5b7a; text-align: center;">Waiting for players...</h2>
            <div class="room-code" id="displayCode" style="text-align: center;">---</div>
            <div class="share-code">Share this code with family!</div>
            <div id="waitingPlayers" style="margin-top: 20px;"></div>
            <button class="setup-btn primary" id="startBtn" onclick="startGame()" style="margin-top: 20px;" disabled>Start Game</button>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden">
            <div class="card">
                <div class="timer" id="timer">5:00</div>
                <div class="baby-container">
                    <svg class="baby-svg" id="babySvg" viewBox="0 0 100 100">
                        <!-- Blanket -->
                        <ellipse cx="50" cy="65" rx="40" ry="25" fill="#b8d4e8"/>
                        <!-- Face -->
                        <circle cx="50" cy="40" r="28" fill="#ffdab9"/>
                        <!-- Blush -->
                        <circle cx="35" cy="45" r="5" fill="#ffb6c1" opacity="0.5"/>
                        <circle cx="65" cy="45" r="5" fill="#ffb6c1" opacity="0.5"/>
                        <!-- Closed eyes (sleeping) -->
                        <path id="leftEye" d="M 35 38 Q 40 42 45 38" stroke="#666" stroke-width="2" fill="none"/>
                        <path id="rightEye" d="M 55 38 Q 60 42 65 38" stroke="#666" stroke-width="2" fill="none"/>
                        <!-- Mouth -->
                        <path id="mouth" d="M 45 52 Q 50 55 55 52" stroke="#666" stroke-width="2" fill="none"/>
                        <!-- Hair tuft -->
                        <path d="M 45 15 Q 50 8 55 15" stroke="#8b7355" stroke-width="3" fill="none"/>
                        <!-- Zzz -->
                        <g id="zzz">
                            <text x="75" y="25" font-size="10" fill="#9b8aa6">z</text>
                            <text x="82" y="18" font-size="8" fill="#9b8aa6">z</text>
                            <text x="87" y="12" font-size="6" fill="#9b8aa6">z</text>
                        </g>
                    </svg>
                    <div class="status-label" id="statusLabel">Loading...</div>
                </div>
                <button class="pass-btn" id="passBtn" onclick="passBaby()" disabled>Pass Baby ðŸ’•</button>
            </div>

            <div class="players-card" id="playersCard">
                <div class="players-title">Family Hugs</div>
                <div id="playersList"></div>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="card game-over hidden">
            <h2>Time's Up!</h2>
            <div>Most hugs goes to...</div>
            <div class="winner-name" id="winnerName">---</div>
            <div id="finalScores"></div>
            <button class="setup-btn primary" onclick="newGame()" style="margin-top: 20px;">Play Again</button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://jsonblob.com/api/jsonBlob';
        const POLL_INTERVAL = 500;
        const FAMILY = ['Dad', 'Mum', 'G-Ma', 'G-Dad', 'Sis', 'Bro', 'Uncle', 'Aunty', 'Bubba', 'Tot'];
        
        let blobId = '';
        let myId = '';
        let myRole = '';
        let gameState = null;
        let pollTimer = null;
        let localHugs = 0;
        let holdStartTime = null;
        let lastWakeTime = 0;

        // Generate 3-letter code
        function genCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
            return Array(3).fill().map(() => chars[Math.floor(Math.random() * chars.length)]).join('');
        }

        function genId() {
            return Math.random().toString(36).substring(2, 10);
        }

        // Setup family grid
        function initFamilyGrid() {
            const grid = document.getElementById('familyGrid');
            grid.innerHTML = FAMILY.map(f => 
                `<button class="family-btn" onclick="selectRole('${f}')">${f}</button>`
            ).join('');
        }

        function selectRole(role) {
            myRole = role;
            document.querySelectorAll('.family-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function showJoin() {
            document.getElementById('joinSection').classList.toggle('hidden');
        }

        async function createGame() {
            if (!myRole) { alert('Pick a family member!'); return; }
            myId = genId();
            const code = genCode();
            const duration = parseInt(document.getElementById('gameLength').value) * 60;
            
            const initialState = {
                code: code,
                host: myId,
                status: 'waiting',
                duration: duration,
                timeLeft: duration,
                players: [{ id: myId, role: myRole, hugs: 0, pending: 0 }],
                holder: null,
                nextWake: null,
                lastUpdate: Date.now()
            };
            
            try {
                const resp = await fetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(initialState)
                });
                blobId = resp.headers.get('X-jsonblob-Id');
                gameState = initialState;
                
                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('waitingScreen').classList.remove('hidden');
                document.getElementById('displayCode').textContent = code;
                
                startPolling();
                renderWaiting();
            } catch (e) {
                alert('Error creating game: ' + e.message);
            }
        }

        async function joinGame() {
            if (!myRole) { alert('Pick a family member!'); return; }
            myId = genId();
            const code = document.getElementById('joinCode').value.toUpperCase().trim();
            if (code.length !== 3) { alert('Enter 3-letter code'); return; }
            
            // Find game by code - we need to search or use code as blob ID
            // For simplicity, we'll use code as part of a known blob lookup
            // Actually, let's store code->blobId mapping differently
            // For now, let's try fetching with code as ID (host will share full link)
            
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            
            if (roomParam) {
                blobId = roomParam;
            } else {
                // Try to find by iterating (not ideal but works for demo)
                alert('Please use the full link shared by the host');
                return;
            }
            
            try {
                await fetchState();
                if (!gameState || gameState.code !== code) {
                    alert('Game not found!');
                    return;
                }
                
                if (gameState.players.find(p => p.role === myRole)) {
                    alert(myRole + ' is already taken!');
                    return;
                }
                
                gameState.players.push({ id: myId, role: myRole, hugs: 0, pending: 0 });
                await saveState();
                
                document.getElementById('setupScreen').classList.add('hidden');
                
                if (gameState.status === 'waiting') {
                    document.getElementById('waitingScreen').classList.remove('hidden');
                    document.getElementById('displayCode').textContent = code;
                } else {
                    document.getElementById('gameScreen').classList.remove('hidden');
                }
                
                startPolling();
            } catch (e) {
                alert('Could not join: ' + e.message);
            }
        }

        async function fetchState() {
            const resp = await fetch(API_BASE + '/' + blobId);
            if (!resp.ok) throw new Error('Game not found');
            gameState = await resp.json();
            return gameState;
        }

        async function saveState() {
            await fetch(API_BASE + '/' + blobId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(gameState)
            });
        }

        function startPolling() {
            pollTimer = setInterval(poll, POLL_INTERVAL);
            poll();
        }

        async function poll() {
            try {
                await fetchState();
                
                if (gameState.status === 'waiting') {
                    renderWaiting();
                } else if (gameState.status === 'playing') {
                    updateGame();
                    renderGame();
                } else if (gameState.status === 'ended') {
                    renderGameOver();
                }
            } catch (e) {
                console.error('Poll error:', e);
            }
        }

        function renderWaiting() {
            const list = document.getElementById('waitingPlayers');
            list.innerHTML = gameState.players.map(p => 
                `<div class="player-row"><span class="player-name">${p.role}</span></div>`
            ).join('');
            
            document.getElementById('startBtn').disabled = gameState.players.length < 2;
            
            // Update URL for sharing
            history.replaceState(null, '', '?room=' + blobId);
        }

        async function startGame() {
            if (gameState.host !== myId) return;
            
            gameState.status = 'playing';
            gameState.holder = gameState.players[0].id;
            gameState.nextWake = Date.now() + (15000 + Math.random() * 20000);
            gameState.startTime = Date.now();
            gameState.lastUpdate = Date.now();
            
            await saveState();
            
            document.getElementById('waitingScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
        }

        function updateGame() {
            const now = Date.now();
            
            // Update time left
            const elapsed = (now - gameState.startTime) / 1000;
            gameState.timeLeft = Math.max(0, gameState.duration - elapsed);
            
            // Check if game ended
            if (gameState.timeLeft <= 0 && gameState.status === 'playing') {
                endGame();
                return;
            }
            
            // Check if baby wakes (only host processes this)
            if (gameState.host === myId && now > gameState.nextWake && gameState.status === 'playing') {
                wakeBaby();
            }
            
            // Update pending hugs for current holder
            if (gameState.holder === myId && holdStartTime) {
                localHugs = Math.floor((now - holdStartTime) / 1000);
            }
        }

        async function wakeBaby() {
            const holder = gameState.players.find(p => p.id === gameState.holder);
            if (holder) {
                holder.pending = 0; // Lose pending hugs
            }
            
            // Pass to next player
            const currentIdx = gameState.players.findIndex(p => p.id === gameState.holder);
            const nextIdx = (currentIdx + 1) % gameState.players.length;
            gameState.holder = gameState.players[nextIdx].id;
            gameState.nextWake = Date.now() + (15000 + Math.random() * 25000);
            gameState.wakeTime = Date.now();
            
            await saveState();
            
            // Flash effect
            document.getElementById('gameScreen').classList.add('wake-flash');
            setTimeout(() => document.getElementById('gameScreen').classList.remove('wake-flash'), 500);
            
            holdStartTime = gameState.holder === myId ? Date.now() : null;
            localHugs = 0;
        }

        async function passBaby() {
            if (gameState.holder !== myId) return;
            
            // Save pending hugs
            const me = gameState.players.find(p => p.id === myId);
            if (me && localHugs > 0) {
                me.hugs += localHugs;
                me.pending = 0;
            }
            
            // Pass to next
            const currentIdx = gameState.players.findIndex(p => p.id === myId);
            const nextIdx = (currentIdx + 1) % gameState.players.length;
            gameState.holder = gameState.players[nextIdx].id;
            
            await saveState();
            
            holdStartTime = null;
            localHugs = 0;
        }

        async function endGame() {
            if (gameState.host !== myId) return;
            
            // Save any pending hugs for holder
            const holder = gameState.players.find(p => p.id === gameState.holder);
            if (holder) {
                holder.hugs += holder.pending || 0;
            }
            
            gameState.status = 'ended';
            await saveState();
        }

        function renderGame() {
            // Timer
            const mins = Math.floor(gameState.timeLeft / 60);
            const secs = Math.floor(gameState.timeLeft % 60);
            document.getElementById('timer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            // Baby state
            const holder = gameState.players.find(p => p.id === gameState.holder);
            const babySvg = document.getElementById('babySvg');
            const statusLabel = document.getElementById('statusLabel');
            
            const recentWake = gameState.wakeTime && (Date.now() - gameState.wakeTime) < 2000;
            
            if (recentWake) {
                babySvg.classList.add('awake');
                babySvg.classList.remove('wiggle');
                // Awake eyes
                document.getElementById('leftEye').setAttribute('d', 'M 35 38 m -5 0 a 5 5 0 1 0 10 0 a 5 5 0 1 0 -10 0');
                document.getElementById('rightEye').setAttribute('d', 'M 60 38 m -5 0 a 5 5 0 1 0 10 0 a 5 5 0 1 0 -10 0');
                document.getElementById('mouth').setAttribute('d', 'M 42 52 Q 50 60 58 52');
                document.getElementById('zzz').style.display = 'none';
                statusLabel.textContent = 'ðŸ˜¢ Baby woke up!';
            } else {
                babySvg.classList.remove('awake');
                babySvg.classList.add('wiggle');
                // Sleeping eyes
                document.getElementById('leftEye').setAttribute('d', 'M 35 38 Q 40 42 45 38');
                document.getElementById('rightEye').setAttribute('d', 'M 55 38 Q 60 42 65 38');
                document.getElementById('mouth').setAttribute('d', 'M 45 52 Q 50 55 55 52');
                document.getElementById('zzz').style.display = 'block';
                statusLabel.textContent = holder ? `${holder.role} is hugging the baby` : '';
            }
            
            // Pass button
            const passBtn = document.getElementById('passBtn');
            passBtn.disabled = gameState.holder !== myId;
            
            // Players list
            const maxHugs = Math.max(...gameState.players.map(p => p.hugs + (p.id === myId ? localHugs : 0)), 1);
            const playersList = document.getElementById('playersList');
            
            playersList.innerHTML = gameState.players.map(p => {
                const isHolder = p.id === gameState.holder;
                const displayHugs = p.hugs + (p.id === myId && isHolder ? localHugs : 0);
                const barWidth = (displayHugs / (maxHugs + 10)) * 100;
                
                return `
                    <div class="player-row ${isHolder ? 'holding' : ''}">
                        <span class="player-name">${p.role}${p.id === myId ? ' ðŸ‘ˆ' : ''}</span>
                        <div class="player-bar-container">
                            <div class="player-bar ${isHolder ? 'pending' : ''}" style="width: ${barWidth}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Track hold time
            if (gameState.holder === myId && !holdStartTime) {
                holdStartTime = Date.now();
            } else if (gameState.holder !== myId) {
                holdStartTime = null;
                localHugs = 0;
            }
        }

        function renderGameOver() {
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.remove('hidden');
            
            const sorted = [...gameState.players].sort((a, b) => b.hugs - a.hugs);
            document.getElementById('winnerName').textContent = sorted[0]?.role + '! ðŸ‘¶ðŸ’•';
            
            const maxHugs = Math.max(...sorted.map(p => p.hugs), 1);
            document.getElementById('finalScores').innerHTML = sorted.map(p => `
                <div class="player-row">
                    <span class="player-name">${p.role}</span>
                    <div class="player-bar-container">
                        <div class="player-bar" style="width: ${(p.hugs / maxHugs) * 100}%"></div>
                    </div>
                </div>
            `).join('');
            
            if (pollTimer) clearInterval(pollTimer);
        }

        function newGame() {
            location.href = location.pathname;
        }

        // Check for room in URL on load
        window.addEventListener('DOMContentLoaded', () => {
            initFamilyGrid();
            
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            if (roomParam) {
                blobId = roomParam;
                document.getElementById('joinSection').classList.remove('hidden');
                // Auto-fetch to get code
                fetchState().then(() => {
                    if (gameState) {
                        document.getElementById('joinCode').value = gameState.code;
                    }
                }).catch(() => {});
            }
        });
    </script>
</body>
</html>
